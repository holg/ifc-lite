<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFC-Lite Viewer</title>
    <link data-trunk rel="css" href="static/styles.css">
</head>
<body>
    <script>
        // =================================================================
        // Unified Mode - Yew + Bevy in single WASM
        // =================================================================

        // Flag to indicate unified mode (checked by Yew bridge)
        window.isUnifiedMode = function() { return true; };

        // Bevy state tracking
        window._bevyStarted = false;
        window.isBevyLoaded = function() { return window._bevyStarted; };
        window.isBevyLoading = function() { return false; };

        // This will be set by the WASM module
        window.startBevyUnified = null;

        // Fake loadBevyViewer for compatibility - just starts Bevy from WASM
        window.loadBevyViewer = async function() {
            if (window._bevyStarted) return;
            if (window.startBevyUnified) {
                console.log('[Unified] Starting Bevy renderer...');
                window._bevyStarted = true;
                window.startBevyUnified('#bevy-canvas');
            } else {
                console.error('[Unified] startBevyUnified not available yet');
            }
        };

        // =================================================================
        // Geometry Bridge - same as before, used for Yew->Bevy data transfer
        // =================================================================
        window.ifcGeometryBinary = null;
        window.ifcEntityData = null;
        window.ifcDataTimestamp = '';
        window.ifcGeometryChunks = [];
        window.ifcStreamingMode = false;

        window.setIfcGeometryBinary = function(uint8Array) {
            window.ifcGeometryChunks = [];
            window.ifcStreamingMode = false;
            window.ifcGeometryBinary = uint8Array;
            window.ifcDataTimestamp = Date.now().toString();
            console.log('[JS Bridge] Geometry binary set:', uint8Array.length, 'bytes');
        };

        window.appendIfcGeometryBinary = function(uint8Array) {
            window.ifcStreamingMode = true;
            window.ifcGeometryChunks.push(uint8Array);
            window.ifcDataTimestamp = Date.now().toString();
        };

        window.finalizeIfcGeometry = function() {
            if (window.ifcStreamingMode && window.ifcGeometryChunks.length > 0) {
                const totalSize = window.ifcGeometryChunks.reduce((sum, chunk) => sum + chunk.length, 0);
                const combined = new Uint8Array(totalSize);
                let offset = 0;
                for (const chunk of window.ifcGeometryChunks) {
                    combined.set(chunk, offset);
                    offset += chunk.length;
                }
                window.ifcGeometryBinary = combined;
                window.ifcGeometryChunks = [];
                window.ifcDataTimestamp = Date.now().toString();
                console.log('[JS Bridge] Geometry finalized:', totalSize, 'bytes');
            }
        };

        window.getIfcGeometryBinary = function() {
            return window.ifcGeometryBinary;
        };

        window.setIfcEntities = function(json) {
            window.ifcEntityData = json;
        };

        window.getIfcEntities = function() {
            return window.ifcEntityData;
        };

        window.getIfcTimestamp = function() {
            return window.ifcDataTimestamp;
        };

        window.clearIfcGeometryBridge = function() {
            if (window.ifcGeometryBinary) {
                const size = window.ifcGeometryBinary.length;
                window.ifcGeometryBinary = null;
                console.log('[JS Bridge] Cleared geometry, freed', size, 'bytes');
            }
        };
    </script>

    <!-- Trunk will inject the unified WASM here -->
    <link data-trunk rel="rust" href="Cargo.toml" data-wasm-opt="0" data-target-name="ifc_lite_viewer" />
</body>
</html>
